openapi: 3.1.0
info:
  title: Cyoda Cloud Workflow API
  version: 1.0.0
  description: |
    API for Cyoda Cloud workflow management providing endpoints for configuring workflows for entity models.
  contact:
    name: Cyoda Support
    url: https://cyoda.com/support

security:
  - bearerAuth: [ ]

paths:
  /model/{entityName}/{modelVersion}/workflow/export:
    get:
      summary: Export entity workflows
      description: |
        Exports all workflow configurations for a specific entity type.

        Since one entity type can have multiple workflows (selected by workflow-level conditions),
        this endpoint returns a collection of all workflows configured for the entity type.
      operationId: exportEntityModelWorkflow
      tags:
        - Entity Model, Workflow
      security:
        - bearerAuth: [ ]
      parameters:
        - name: entityName
          in: path
          required: true
          description: Name of the entity model
          schema:
            type: string
            example: "Customer"
        - name: modelVersion
          in: path
          required: true
          description: Version of the entity model
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Workflows exported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowExportResponse'
              examples:
                SuccessfulExport:
                  summary: Successful workflows export
                  description: Example response when workflows are successfully exported
                  value: |
                    {
                      "entityName": "Customer",
                      "modelVersion": 1,
                      "workflows": [
                        {
                          "version": "1.0",
                          "name": "Premium Customer Workflow",
                          "desc": "Workflow for premium customers with enhanced features and validation",
                          "initialState": "draft",
                          "active": true,
                          "criterion": {
                            "type": "simple",
                            "jsonPath": "$.customerType",
                            "operation": "EQUALS",
                            "value": "premium"
                          },
                          "states": {
                            "draft": {
                              "transitions": [
                                {
                                  "name": "validate",
                                  "next": "validation",
                                  "manual": false,
                                  "processors": [
                                    {
                                      "type": "externalized",
                                      "name": "validate_customer_data",
                                      "executionMode": "SYNC",
                                      "config": {
                                        "attachEntity": true,
                                        "calculationNodesTags": "validation,data-quality",
                                        "responseTimeoutMs": 3000,
                                        "retryPolicy": "FIXED"
                                      }
                                    }
                                  ]
                                },
                                {
                                  "name": "reject",
                                  "next": "rejected",
                                  "manual": true
                                }
                              ]
                            },
                            "validation": {
                              "transitions": [
                                {
                                  "name": "approve",
                                  "next": "active",
                                  "manual": true,
                                  "criterion": {
                                    "type": "group",
                                    "operator": "AND",
                                    "conditions": [
                                      {
                                        "type": "simple",
                                        "jsonPath": "$.creditScore",
                                        "operation": "GREATER_OR_EQUAL",
                                        "value": 700
                                      },
                                      {
                                        "type": "simple",
                                        "jsonPath": "$.annualRevenue",
                                        "operation": "GREATER_THAN",
                                        "value": 1000000
                                      }
                                    ]
                                  },
                                  "processors": [
                                    {
                                      "type": "externalized",
                                      "name": "setup_premium_features",
                                      "executionMode": "ASYNC_NEW_TX",
                                      "config": {
                                        "attachEntity": true,
                                        "calculationNodesTags": "premium,setup",
                                        "responseTimeoutMs": 10000,
                                        "retryPolicy": "FIXED"
                                      }
                                    }
                                  ]
                                },
                                {
                                  "name": "reject",
                                  "next": "rejected",
                                  "manual": true
                                }
                              ]
                            },
                            "active": {
                              "transitions": [
                                {
                                  "name": "suspend",
                                  "next": "suspended",
                                  "manual": true
                                },
                                {
                                  "name": "upgrade",
                                  "next": "vip",
                                  "manual": false,
                                  "criterion": {
                                    "type": "function",
                                    "function": {
                                      "name": "check_vip_eligibility",
                                      "config": {
                                        "attachEntity": true,
                                        "calculationNodesTags": "vip,eligibility",
                                        "responseTimeoutMs": 5000,
                                        "retryPolicy": "FIXED"
                                      },
                                      "criterion": {
                                        "type": "simple",
                                        "jsonPath": "$.totalSpent",
                                        "operation": "GREATER_THAN",
                                        "value": 100000
                                      }
                                    }
                                  }
                                }
                              ]
                            },
                            "vip": {
                              "transitions": [
                                {
                                  "name": "downgrade",
                                  "next": "active",
                                  "manual": true
                                }
                              ]
                            },
                            "suspended": {
                              "transitions": [
                                {
                                  "name": "reactivate",
                                  "next": "active",
                                  "manual": true
                                }
                              ]
                            },
                            "rejected": {
                              "transitions": []
                            }
                          }
                        },
                        {
                          "version": "1.0",
                          "name": "Standard Customer Workflow",
                          "desc": "Default workflow for standard customers with basic validation",
                          "initialState": "pending",
                          "active": true,
                          "criterion": {
                            "type": "group",
                            "operator": "OR",
                            "conditions": [
                              {
                                "type": "simple",
                                "jsonPath": "$.customerType",
                                "operation": "EQUALS",
                                "value": "standard"
                              },
                              {
                                "type": "simple",
                                "jsonPath": "$.customerType",
                                "operation": "IS_NULL"
                              }
                            ]
                          },
                          "states": {
                            "pending": {
                              "transitions": [
                                {
                                  "name": "approve",
                                  "next": "active",
                                  "manual": false,
                                  "criterion": {
                                    "type": "function",
                                    "function": {
                                      "name": "check_standard_eligibility",
                                      "config": {
                                        "attachEntity": false,
                                        "calculationNodesTags": "eligibility,standard",
                                        "responseTimeoutMs": 2000
                                      }
                                    }
                                  }
                                },
                                {
                                  "name": "reject",
                                  "next": "rejected",
                                  "manual": true
                                }
                              ]
                            },
                            "active": {
                              "transitions": [
                                {
                                  "name": "suspend",
                                  "next": "suspended",
                                  "manual": true
                                }
                              ]
                            },
                            "suspended": {
                              "transitions": [
                                {
                                  "name": "reactivate",
                                  "next": "active",
                                  "manual": true
                                }
                              ]
                            },
                            "rejected": {
                              "transitions": []
                            }
                          }
                        }
                      ]
                    }
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '404':
          $ref: '#/components/responses/ErrorResponse'
        '500':
          $ref: '#/components/responses/ErrorResponse'

  /model/{entityName}/{modelVersion}/workflow/import:
    post:
      summary: Import entity workflow
      description: |
        Imports or updates workflow configurations for a specific entity type.

        Since workflow name must be unique per entity model, this endpoint will either create
        new workflow or update existing workflow with the same name.

        The workflow configuration structure is defined by versioned schemas and may vary
        depending on the version specified in the configuration.
      operationId: importEntityModelWorkflow
      tags:
        - Entity Model, Workflow
      security:
        - bearerAuth: [ ]
      parameters:
        - name: entityName
          in: path
          required: true
          description: Name of the entity model
          schema:
            type: string
            example: "Customer"
        - name: modelVersion
          in: path
          required: true
          description: Version of the entity model
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        description: Workflow configurations to import
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowImportRequest'
            examples:
              SampleWorkflow:
                summary: Workflow import
                description: Example of importing workflow configurations with REPLACE mode
                value: |
                  {
                    "importMode": "REPLACE",
                    "workflows": [
                      {
                        "version": "1.0",
                        "name": "Enterprise Customer Workflow",
                        "desc": "Advanced workflow for enterprise customers with multi-stage approval and external validation",
                        "initialState": "draft",
                        "active": true,
                        "criterion": {
                          "type": "group",
                          "operator": "AND",
                          "conditions": [
                            {
                              "type": "simple",
                              "jsonPath": "$.customerType",
                              "operation": "EQUALS",
                              "value": "enterprise"
                            },
                            {
                              "type": "simple",
                              "jsonPath": "$.contractValue",
                              "operation": "GREATER_THAN",
                              "value": 500000
                            }
                          ]
                        },
                        "states": {
                          "draft": {
                            "transitions": [
                              {
                                "name": "submit_for_review",
                                "next": "under_review",
                                "manual": true,
                                "processors": [
                                  {
                                    "type": "externalized",
                                    "name": "validate_enterprise_data",
                                    "executionMode": "SYNC",
                                    "config": {
                                      "attachEntity": true,
                                      "calculationNodesTags": "validation,enterprise",
                                      "responseTimeoutMs": 5000,
                                      "retryPolicy": "FIXED"
                                    }
                                  },
                                  {
                                    "type": "externalized",
                                    "name": "notify_review_team",
                                    "executionMode": "ASYNC_NEW_TX",
                                    "config": {
                                      "attachEntity": false,
                                      "calculationNodesTags": "notification",
                                      "responseTimeoutMs": 2000
                                    }
                                  }
                                ]
                              }
                            ]
                          },
                          "under_review": {
                            "transitions": [
                              {
                                "name": "approve",
                                "next": "approved",
                                "manual": true,
                                "criterion": {
                                  "type": "function",
                                  "function": {
                                    "name": "check_compliance_requirements",
                                    "config": {
                                      "attachEntity": true,
                                      "calculationNodesTags": "compliance,legal",
                                      "responseTimeoutMs": 10000,
                                      "retryPolicy": "FIXED",
                                      "context": "enterprise_approval"
                                    },
                                    "criterion": {
                                      "type": "simple",
                                      "jsonPath": "$.complianceScore",
                                      "operation": "GREATER_OR_EQUAL",
                                      "value": 85
                                    }
                                  }
                                }
                              },
                              {
                                "name": "request_more_info",
                                "next": "pending_info",
                                "manual": true
                              },
                              {
                                "name": "reject",
                                "next": "rejected",
                                "manual": true
                              }
                            ]
                          },
                          "pending_info": {
                            "transitions": [
                              {
                                "name": "resubmit",
                                "next": "under_review",
                                "manual": true
                              }
                            ]
                          },
                          "approved": {
                            "transitions": [
                              {
                                "name": "activate",
                                "next": "active",
                                "manual": false,
                                "processors": [
                                  {
                                    "type": "externalized",
                                    "name": "setup_enterprise_features",
                                    "executionMode": "ASYNC_NEW_TX",
                                    "config": {
                                      "attachEntity": true,
                                      "calculationNodesTags": "setup,enterprise,features",
                                      "responseTimeoutMs": 15000,
                                      "retryPolicy": "FIXED"
                                    }
                                  }
                                ]
                              }
                            ]
                          },
                          "active": {
                            "transitions": [
                              {
                                "name": "suspend",
                                "next": "suspended",
                                "manual": true
                              },
                              {
                                "name": "renew",
                                "next": "renewal_pending",
                                "manual": false,
                                "criterion": {
                                  "type": "simple",
                                  "jsonPath": "$.contractExpiryDate",
                                  "operation": "LESS_THAN",
                                  "value": "2024-12-31"
                                },
                                "processors": [
                                  {
                                    "type": "scheduled",
                                    "name": "schedule_terminate_one_hour",
                                    "config": {
                                      "delayMs": 3600000,
                                      "transition": "terminate"
                                    }
                                  }
                                ]
                              }
                            ]
                          },
                          "renewal_pending": {
                            "transitions": [
                              {
                                "name": "renew_contract",
                                "next": "active",
                                "manual": true
                              },
                              {
                                "name": "terminate",
                                "next": "terminated",
                                "manual": true
                              }
                            ]
                          },
                          "suspended": {
                            "transitions": [
                              {
                                "name": "reactivate",
                                "next": "active",
                                "manual": true
                              }
                            ]
                          },
                          "rejected": {
                            "transitions": []
                          },
                          "terminated": {
                            "transitions": []
                          }
                        }
                      },
                      {
                        "version": "1.0",
                        "name": "Basic Customer Workflow",
                        "desc": "Simple workflow for basic customers with minimal validation",
                        "initialState": "new",
                        "active": true,
                        "criterion": {
                          "type": "group",
                          "operator": "OR",
                          "conditions": [
                            {
                              "type": "simple",
                              "jsonPath": "$.customerType",
                              "operation": "EQUALS",
                              "value": "basic"
                            },
                            {
                              "type": "simple",
                              "jsonPath": "$.customerType",
                              "operation": "IS_NULL"
                            }
                          ]
                        },
                        "states": {
                          "new": {
                            "transitions": [
                              {
                                "name": "auto_approve",
                                "next": "active",
                                "manual": false,
                                "criterion": {
                                  "type": "simple",
                                  "jsonPath": "$.autoApprovalEligible",
                                  "operation": "EQUALS",
                                  "value": true
                                }
                              },
                              {
                                "name": "manual_review",
                                "next": "pending_review",
                                "manual": false
                              }
                            ]
                          },
                          "pending_review": {
                            "transitions": [
                              {
                                "name": "approve",
                                "next": "active",
                                "manual": true
                              },
                              {
                                "name": "reject",
                                "next": "rejected",
                                "manual": true
                              }
                            ]
                          },
                          "active": {
                            "transitions": [
                              {
                                "name": "deactivate",
                                "next": "inactive",
                                "manual": true
                              }
                            ]
                          },
                          "inactive": {
                            "transitions": [
                              {
                                "name": "reactivate",
                                "next": "active",
                                "manual": true
                              }
                            ]
                          },
                          "rejected": {
                            "transitions": []
                          }
                        }
                      }
                    ]
                  }
              SimpleWorkflowImport:
                summary: Simple workflow import
                description: Basic example for importing a single workflow with minimal configuration in MERGE mode
                value: |
                  {
                    "importMode": "MERGE",
                    "workflows": [
                      {
                        "version": "1.0",
                        "name": "Simple Approval Workflow",
                        "desc": "Basic two-state approval workflow",
                        "initialState": "pending",
                        "active": true,
                        "states": {
                          "pending": {
                            "transitions": [
                              {
                                "name": "approve",
                                "next": "approved",
                                "manual": true
                              },
                              {
                                "name": "reject",
                                "next": "rejected",
                                "manual": true
                              }
                            ]
                          },
                          "approved": {
                            "transitions": []
                          },
                          "rejected": {
                            "transitions": []
                          }
                        }
                      }
                    ]
                  }
      responses:
        '200':
          description: Workflows imported successfully
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '404':
          $ref: '#/components/responses/ErrorResponse'
        '500':
          $ref: '#/components/responses/ErrorResponse'

components:
  responses:
    ErrorResponse:
      description: Error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from the authentication endpoint

  schemas:
    # ErrorResponse schema - same object as defined in the main openapi.yml
    ErrorResponse:
      $ref: './openapi.yml#/components/schemas/ErrorResponse'

    WorkflowImportMode:
      type: string
      description: |
        Specifies how the import operation should handle existing workflows and related configurations.

        - **REPLACE**: Removes all existing workflows for the entity and retains only the imported ones.
          Also deletes all unused processors and criteria associated with the entity.
        - **ACTIVATE**: Similar to REPLACE, but instead of removing other workflows and transitions, it deactivates them.
          Unused processors and criteria are preserved.
        - **MERGE**: Performs an incremental update of the specified workflows. Any unspecified
          configurations remain unchanged.
      enum:
        - REPLACE
        - ACTIVATE
        - MERGE

    ProcessorExecutionMode:
      type: string
      description: Execution mode of the processor
      enum:
        - SYNC
        - ASYNC_SAME_TX
        - ASYNC_NEW_TX
      default: ASYNC_NEW_TX

    ExternalizedProcessorConfig:
      allOf:
        - $ref: './openapi-common.yml#/components/schemas/ExternalizedFunctionConfig'
        - type: object
          description: Configuration for externalized processor with async options
          properties:
            asyncResult:
              type: boolean
              description: Whether to await the result asynchronously, outside of the transaction
            crossoverToAsyncMs:
              type: integer
              format: int64
              description: Crossover delay to switch to asynchronous processing (ms), effective only when asyncResult is true

    ProcessorDefinition:
      type: object
      description: Base processor definition with type discriminator
      discriminator:
        propertyName: type
        mapping:
          externalized: '#/components/schemas/ExternalizedProcessorDefinition'
          scheduled: '#/components/schemas/ScheduledTransitionProcessorDefinition'
      properties:
        type:
          type: string
          description: Type of the processor (externalized or scheduled)
        name:
          type: string
          description: Name of the processor
      required:
        - name

    ExternalizedProcessorDefinition:
      allOf:
        - $ref: '#/components/schemas/ProcessorDefinition'
        - type: object
          description: Definition of an externalized processor for state transition logic
          properties:
            executionMode:
              $ref: '#/components/schemas/ProcessorExecutionMode'
            config:
              $ref: '#/components/schemas/ExternalizedProcessorConfig'

    ScheduledTransitionProcessorDefinition:
      allOf:
        - $ref: '#/components/schemas/ProcessorDefinition'
        - type: object
          description: Definition of a scheduled processor for delayed state transitions
          properties:
            config:
              $ref: './openapi-common.yml#/components/schemas/ScheduledTransitionConfig'
          required:
            - config

    TransitionDefinition:
      type: object
      description: Definition of a state transition
      properties:
        name:
          type: string
          description: Name of the transition
        next:
          type: string
          description: Target state code for this transition
        manual:
          type: boolean
          description: Whether this transition requires manual triggering
        disabled:
          type: boolean
          description: Flag indicating if the transition is disabled
        processors:
          type: array
          description: List of processors to execute for this transition
          items:
            $ref: '#/components/schemas/ProcessorDefinition'
        criterion:
          $ref: './openapi-common.yml#/components/schemas/QueryCondition'
          description: Criterion that must be met for this transition to be effective
      required:
        - name
        - next
        - manual

    StateDefinition:
      type: object
      description: Definition of a workflow state
      properties:
        transitions:
          type: array
          description: List of possible transitions from this state
          items:
            $ref: '#/components/schemas/TransitionDefinition'
      additionalProperties: false

    WorkflowConfiguration:
      type: object
      description: |
        Workflow configuration schema version 1.0. Supports workflow-level and transition-level
        criterion using QueryCondition types: simple, group, and function.
      properties:
        version:
          type: string
          description: Version of the workflow configuration schema
          default: "1.0"
        name:
          type: string
          description: Name of the workflow
        desc:
          type: string
          description: Description of the workflow
        initialState:
          type: string
          description: Initial state for entities in this workflow
        active:
          type: boolean
          description: Flag indicating if the workflow is active
        criterion:
          $ref: './openapi-common.yml#/components/schemas/QueryCondition'
          description: Optional criterion to determine if this workflow is applicable to an entity
        states:
          type: object
          description: Map of state codes to state definitions
          additionalProperties:
            $ref: '#/components/schemas/StateDefinition'
          minProperties: 1
      required:
        - version
        - name
        - initialState
        - states

    WorkflowExportResponse:
      type: object
      description: Response containing the exported workflow configurations
      properties:
        entityName:
          type: string
          description: The name of the entity model
        modelVersion:
          type: integer
          description: The version number of the entity model
        workflows:
          type: array
          description: Collection of workflow configurations for the entity model
          items:
            $ref: '#/components/schemas/WorkflowConfiguration'
      required:
        - entityName
        - modelVersion
        - workflows

    WorkflowImportRequest:
      type: object
      description: Request containing workflow configurations to import
      properties:
        workflows:
          type: array
          description: Array of workflow configurations to import
          items:
            $ref: '#/components/schemas/WorkflowConfiguration'
        importMode:
          description: Import mode for handling existing workflows
          $ref: '#/components/schemas/WorkflowImportMode'
          default: MERGE
      required:
        - workflows

